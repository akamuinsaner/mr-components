var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,a=1,r=arguments.length;a<r;a++)for(var n in t=arguments[a])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)},__rest=this&&this.__rest||function(e,t){var a={};for(n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var r=0,n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(a[n[r]]=e[n[r]]);return a},__read=this&&this.__read||function(e,t){var a="function"==typeof Symbol&&e[Symbol.iterator];if(!a)return e;var r,n,o=a.call(e),i=[];try{for(;(void 0===t||0<t--)&&!(r=o.next()).done;)i.push(r.value)}catch(e){n={error:e}}finally{try{r&&!r.done&&(a=o.return)&&a.call(o)}finally{if(n)throw n.error}}return i},__spreadArray=this&&this.__spreadArray||function(e,t,a){if(a||2===arguments.length)for(var r,n=0,o=t.length;n<o;n++)!r&&n in t||((r=r||Array.prototype.slice.call(t,0,n))[n]=t[n]);return e.concat(r||Array.prototype.slice.call(t))};import{jsx as _jsx,Fragment as _Fragment,jsxs as _jsxs}from"react/jsx-runtime";import React from"react";import TextField from"@mui/material/TextField";import ArrowDropDownIcon from"@mui/icons-material/ArrowDropDown";import Autocomplete from"@mui/material/Autocomplete";import CancelIcon from"@mui/icons-material/Cancel";import Chip from"@mui/material/Chip";import Tag from"./Tag";import DropDown from"./DropDown";import Options from"./Options";import useTagLimits from"./useTagLimits";import getTreeDataFormatted from"../utils/getTreeDataFormatted";import useExpanded from"./useExpanded";var TreeSelect=function(e){function t(){return S([])}function a(e){e.stopPropagation(),k(""),b(C.current)}function r(e){k(""),b(null),document.removeEventListener("click",r)}function n(){var e;return s?A:!!j&&i?O:(null==(e=T.get(A[0]))?void 0:e.name)||""}var o=e.search,i=void 0!==o&&o,l=e.options,o=e.multiple,s=void 0!==o&&o,o=e.placement,o=void 0===o?"bottom-start":o,c=e.checkable,c=void 0!==c&&c,p=e.checkWithRelation,u=e.defaultExpandAll,u=void 0!==u&&u,d=e.defaultExpandedKeys,f=e.popperStyle,f=void 0===f?{}:f,m=e.popperClassName,_=e.value,W=e.expandedKeys,h=e.onChange,L=e.onExpand,P=e.loadData,g=e.allowClear,g=void 0!==g&&g,x=e.maxTagCount,y=void 0===x?0:x,v=__rest(e,["search","options","multiple","placement","checkable","checkWithRelation","defaultExpandAll","defaultExpandedKeys","popperStyle","popperClassName","value","expandedKeys","onChange","onExpand","loadData","allowClear","maxTagCount"]),C=React.useRef(null),x=React.useRef(null),D=React.useRef(!1),e=__read(React.useState(getTreeDataFormatted(l)),2),E=e[0],M=e[1],e=E.flattedData,T=(E.idChildrenMap,E.idChildrenIdMap,E.idTreeNodeMap),R=(React.useEffect(function(){D.current?M(getTreeDataFormatted(l)):D.current=!0},[l]),__read(React.useState(!1),2)),z=R[0],N=R[1],R=__read(React.useState(null),2),j=R[0],b=R[1],R=__read(React.useState(!1),2),V=R[0],w=R[1],R=__read(React.useState(Array.isArray(_)?_:_?[_]:[]),2),A=R[0],S=R[1],_=__read(React.useState(""),2),O=_[0],k=_[1],R=useExpanded({flattedData:e,defaultExpandAll:u,defaultExpandedKeys:d,expandedKeys:W,onExpand:L}),_=R.expandKeys,e=R.toggleExpand,u=useTagLimits({maxTagCount:y,selected:A,inputRef:C}),F=u.tagLimit,I=u.tagWidths,K=u.setTagWidths;React.useEffect(function(){z?h&&h(s?A:A[0]):N(!0)},[A]),React.useEffect(function(){j&&setTimeout(function(){document.addEventListener("click",r)},300)},[j]);return _jsxs(_Fragment,{children:[_jsx(Autocomplete,{ref:x,options:[],open:!1,disabled:v.disabled,onFocus:a,readOnly:!(i&&j),multiple:s,disableClearable:!0,value:n(),inputValue:O,onClick:function(e){return e.stopPropagation()},onInputChange:function(e,t,a){"reset"===a&&s||k(t)},onMouseEnter:function(e){return w(!0)},onMouseLeave:function(e){return w(!1)},popupIcon:V&&A.length&&g?_jsx(CancelIcon,{onClick:t}):_jsx(ArrowDropDownIcon,{onClick:a}),renderInput:function(e){var t=!!j;return _jsx(TextField,__assign({},e,v,{onClick:function(e){return e.stopPropagation()},focused:t,ref:C,placeholder:t&&!s?n():v.placeholder,sx:{"& .MuiAutocomplete-inputRoot":{flexWrap:"responsive"===y?"nowrap":"wrap"}}}))},renderTags:function(e,t){var a=e.slice(0,F),e=e.slice(F),r=v.size;return a.map(function(e,a){e=T.get(e);return _jsx(Tag,{size:r,onDelete:function(t){S(A.filter(function(e){return e!==t})),K(I.filter(function(e,t){return t!==a}))},option:e,onInit:function(e){var t=__spreadArray([],__read(I),!1);t[a]=e,K(t)}})}).concat(e.length?[_jsx(Chip,{size:r,label:"+".concat(e.length,"...")})]:[])}}),_jsx(DropDown,__assign({anchorEl:j,placement:o,popperStyle:f,popperClassName:m,initialWidth:null==(d=null==x?void 0:x.current)?void 0:d.offsetWidth},{children:_jsx(Options,{dense:"small"===v.size,showCheck:s&&c,search:i,multiple:s,selected:A,inputValue:O,setSelected:S,loadData:P,expandKeys:_,toggleExpand:e,dataSet:E,checkWithRelation:p})}))]})};export default TreeSelect;