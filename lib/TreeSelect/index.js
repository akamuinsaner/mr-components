var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++)for(var r in t=arguments[a])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},__rest=this&&this.__rest||function(e,t){var a={};for(r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(a[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var n=0,r=Object.getOwnPropertySymbols(e);n<r.length;n++)t.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(e,r[n])&&(a[r[n]]=e[r[n]]);return a},__read=this&&this.__read||function(e,t){var a="function"==typeof Symbol&&e[Symbol.iterator];if(!a)return e;var n,r,o=a.call(e),i=[];try{for(;(void 0===t||0<t--)&&!(n=o.next()).done;)i.push(n.value)}catch(e){r={error:e}}finally{try{n&&!n.done&&(a=o.return)&&a.call(o)}finally{if(r)throw r.error}}return i},__spreadArray=this&&this.__spreadArray||function(e,t,a){if(a||2===arguments.length)for(var n,r=0,o=t.length;r<o;r++)!n&&r in t||((n=n||Array.prototype.slice.call(t,0,r))[r]=t[r]);return e.concat(n||Array.prototype.slice.call(t))};import{jsx as _jsx,Fragment as _Fragment,jsxs as _jsxs}from"react/jsx-runtime";import React from"react";import TextField from"@mui/material/TextField";import ArrowDropDownIcon from"@mui/icons-material/ArrowDropDown";import{flatOptions,idAllChildrenMap}from"./helper";import Autocomplete from"@mui/material/Autocomplete";import CancelIcon from"@mui/icons-material/Cancel";import Chip from"@mui/material/Chip";import Tag from"./Tag";import DropDown from"./DropDown";import Options from"./Options";import useTagLimits from"./useTagLimits";import getTreeDataFormatted from"../utils/getTreeDataFormatted";import useExpanded from"./useExpanded";var TreeSelect=function(e){function t(){return b([])}function a(e){e.stopPropagation(),F(""),j(E.current)}function n(e){F(""),j(null),document.removeEventListener("click",n)}function r(){var e;return s?O:!!T&&i?S:(null==(e=A.find(function(e){return e.id===O[0]}))?void 0:e.name)||""}var o=e.search,i=void 0!==o&&o,l=e.options,o=e.multiple,s=void 0!==o&&o,o=e.placement,o=void 0===o?"bottom-start":o,p=e.checkable,p=void 0!==p&&p,u=e.defaultExpandAll,u=void 0!==u&&u,c=e.defaultExpandedKeys,d=e.popperStyle,d=void 0===d?{}:d,f=e.popperClassName,m=e.value,_=e.expandedKeys,h=e.onChange,g=e.onExpand,M=e.loadData,x=e.allowClear,x=void 0!==x&&x,y=e.maxTagCount,v=void 0===y?0:y,C=__rest(e,["search","options","multiple","placement","checkable","defaultExpandAll","defaultExpandedKeys","popperStyle","popperClassName","value","expandedKeys","onChange","onExpand","loadData","allowClear","maxTagCount"]),E=React.useRef(null),y=React.useRef(null),D=React.useRef(!1),e=__read(React.useState(getTreeDataFormatted(l)),2),R=e[0],L=e[1],e=R.flattedData,R=(R.idChildrenIdMap,React.useEffect(function(){D.current?L(getTreeDataFormatted(l)):D.current=!0},[l]),__read(React.useState(!1),2)),P=R[0],W=R[1],R=__read(React.useState(null),2),T=R[0],j=R[1],R=__read(React.useState(!1),2),z=R[0],w=R[1],R=__read(React.useState(Array.isArray(m)?m:m?[m]:[]),2),O=R[0],b=R[1],m=__read(React.useState(flatOptions(l)),2),A=m[0],R=m[1],m=__read(React.useState(new Map),2),N=m[0],V=m[1],m=__read(React.useState(""),2),S=m[0],F=m[1],m=(React.useEffect(function(){V(idAllChildrenMap(l))},[A]),useExpanded({flattedData:e,defaultExpandAll:u,defaultExpandedKeys:c,expandedKeys:_,onExpand:g})),e=m.expandKeys,u=m.toggleExpand,c=(console.log(),useTagLimits({maxTagCount:v,selected:O,inputRef:E})),I=c.tagLimit,k=c.tagWidths,K=c.setTagWidths;React.useEffect(function(){P?h&&h(s?O:O[0]):W(!0)},[O]),React.useEffect(function(){T&&setTimeout(function(){document.addEventListener("click",n)},300)},[T]);return _jsxs(_Fragment,{children:[_jsx(Autocomplete,{ref:y,options:[],open:!1,disabled:C.disabled,onFocus:a,readOnly:!(i&&T),multiple:s,disableClearable:!0,value:r(),inputValue:S,onClick:function(e){return e.stopPropagation()},onInputChange:function(e,t,a){"reset"===a&&s||F(t)},onMouseEnter:function(e){return w(!0)},onMouseLeave:function(e){return w(!1)},popupIcon:z&&O.length&&x?_jsx(CancelIcon,{onClick:t}):_jsx(ArrowDropDownIcon,{onClick:a}),renderInput:function(e){var t=!!T;return _jsx(TextField,__assign({},e,C,{onClick:function(e){return e.stopPropagation()},focused:t,ref:E,placeholder:t&&!s?r():C.placeholder,sx:{"& .MuiAutocomplete-inputRoot":{flexWrap:"responsive"===v?"nowrap":"wrap"}}}))},renderTags:function(e,t){var a=e.slice(0,I),e=e.slice(I),n=C.size;return a.map(function(t,a){var e=A.find(function(e){return e.id===t});return _jsx(Tag,{size:n,onDelete:function(t){b(O.filter(function(e){return e!==t})),K(k.filter(function(e,t){return t!==a}))},option:e,onInit:function(e){var t=__spreadArray([],__read(k),!1);t[a]=e,K(t)}})}).concat(e.length?[_jsx(Chip,{size:n,label:"+".concat(e.length,"...")})]:[])}}),_jsx(DropDown,__assign({anchorEl:T,placement:o,popperStyle:d,popperClassName:f,initialWidth:null==(_=null==y?void 0:y.current)?void 0:_.offsetWidth},{children:_jsx(Options,{dense:"small"===C.size,showCheck:s&&p,search:i,multiple:s,selected:O,inputValue:S,flatOptions:A,setSelected:b,allChildrenMap:N,setFlattedOptions:R,loadData:M,expandKeys:e,toggleExpand:u})}))]})};export default TreeSelect;