var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,a=1,r=arguments.length;a<r;a++)for(var o in t=arguments[a])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},__rest=this&&this.__rest||function(e,t){var a={};for(o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(a[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var r=0,o=Object.getOwnPropertySymbols(e);r<o.length;r++)t.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(a[o[r]]=e[o[r]]);return a},__read=this&&this.__read||function(e,t){var a="function"==typeof Symbol&&e[Symbol.iterator];if(!a)return e;var r,o,n=a.call(e),i=[];try{for(;(void 0===t||0<t--)&&!(r=n.next()).done;)i.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(a=n.return)&&a.call(n)}finally{if(o)throw o.error}}return i},__spreadArray=this&&this.__spreadArray||function(e,t,a){if(a||2===arguments.length)for(var r,o=0,n=t.length;o<n;o++)!r&&o in t||((r=r||Array.prototype.slice.call(t,0,o))[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))};import{jsx as _jsx,Fragment as _Fragment,jsxs as _jsxs}from"react/jsx-runtime";import React from"react";import TextField from"@mui/material/TextField";import ArrowDropDownIcon from"@mui/icons-material/ArrowDropDown";import Autocomplete from"@mui/material/Autocomplete";import CancelIcon from"@mui/icons-material/Cancel";import Chip from"@mui/material/Chip";import Tag from"./Tag";import DropDown from"./DropDown";import Options from"./Options";import useTagLimits from"./useTagLimits";import getTreeDataFormatted from"../utils/getTreeDataFormatted";import useExpanded from"./useExpanded";import useLoadData from"./useLoadData";var TreeSelect=function(e){function t(){return b([])}function a(e){e.stopPropagation(),k(""),A(C.current)}function r(e){k(""),A(null),document.removeEventListener("click",r)}function o(){var e;return s?j:!!w&&i?O:(null==(e=R.get(j[0]))?void 0:e.name)||""}var n=e.search,i=void 0!==n&&n,l=e.options,n=e.multiple,s=void 0!==n&&n,n=e.placement,n=void 0===n?"bottom-start":n,c=e.checkable,c=void 0!==c&&c,K=e.checkWithRelation,p=e.defaultExpandAll,p=void 0!==p&&p,u=e.defaultExpandedKeys,d=e.popperStyle,d=void 0===d?{}:d,W=e.popperClassName,f=e.value,m=e.expandedKeys,_=e.onChange,g=e.onExpand,h=e.loadData,x=e.allowClear,x=void 0!==x&&x,y=e.maxTagCount,v=void 0===y?0:y,D=__rest(e,["search","options","multiple","placement","checkable","checkWithRelation","defaultExpandAll","defaultExpandedKeys","popperStyle","popperClassName","value","expandedKeys","onChange","onExpand","loadData","allowClear","maxTagCount"]),C=React.useRef(null),y=React.useRef(null),E=React.useRef(!1),e=__read(React.useState(getTreeDataFormatted(l)),2),T=e[0],P=e[1],e=T.flattedData,R=T.idTreeNodeMap,f=(React.useEffect(function(){E.current?P(getTreeDataFormatted(l)):E.current=!0},[l]),__read(React.useState(Array.isArray(f)?f:f?[f]:[]),2)),j=f[0],b=f[1],f=__read(React.useState(!1),2),z=f[0],M=f[1],f=(React.useEffect(function(){z?_&&_(s?j:j[0]):M(!0)},[j]),__read(React.useState(null),2)),w=f[0],A=f[1],f=__read(React.useState(!1),2),N=f[0],S=f[1],f=__read(React.useState(""),2),O=f[0],k=f[1],f=useExpanded({flattedData:e,defaultExpandAll:p,defaultExpandedKeys:u,expandedKeys:m,onExpand:g}),e=f.expandKeys,p=f.toggleExpand,u=useTagLimits({maxTagCount:v,selected:j,inputRef:C}),L=u.tagLimit,F=u.tagWidths,I=u.setTagWidths,m=useLoadData({loadData:h,toggleExpand:p}),g=m.loadingId,f=m.startLoadData;React.useEffect(function(){w&&setTimeout(function(){document.addEventListener("click",r)},300)},[w]);return _jsxs(_Fragment,{children:[_jsx(Autocomplete,{ref:y,options:[],open:!1,disabled:D.disabled,onFocus:a,readOnly:!(i&&w),multiple:s,disableClearable:!0,value:o(),inputValue:O,onClick:function(e){return e.stopPropagation()},onInputChange:function(e,t,a){"reset"===a&&s||k(t)},onMouseEnter:function(e){return S(!0)},onMouseLeave:function(e){return S(!1)},popupIcon:N&&j.length&&x?_jsx(CancelIcon,{onClick:t}):_jsx(ArrowDropDownIcon,{onClick:a}),renderInput:function(e){var t=!!w;return _jsx(TextField,__assign({},e,D,{onClick:function(e){return e.stopPropagation()},focused:t,ref:C,placeholder:t&&!s?o():D.placeholder,sx:{"& .MuiAutocomplete-inputRoot":{flexWrap:"responsive"===v?"nowrap":"wrap"}}}))},renderTags:function(e,t){var a=e.slice(0,L),e=e.slice(L),r=D.size;return a.map(function(e,a){e=R.get(e);return _jsx(Tag,{size:r,onDelete:function(t){b(j.filter(function(e){return e!==t})),I(F.filter(function(e,t){return t!==a}))},option:e,onInit:function(e){var t=__spreadArray([],__read(F),!1);t[a]=e,I(t)}})}).concat(e.length?[_jsx(Chip,{size:r,label:"+".concat(e.length,"...")})]:[])}}),_jsx(DropDown,__assign({anchorEl:w,placement:n,popperStyle:d,popperClassName:W,initialWidth:null==(u=null==y?void 0:y.current)?void 0:u.offsetWidth},{children:_jsx(Options,{dense:"small"===D.size,showCheck:s&&c,search:i,multiple:s,selected:j,inputValue:O,setSelected:b,loadData:h,expandKeys:e,toggleExpand:p,dataSet:T,checkWithRelation:K,loadingId:g,startLoadData:f})}))]})};export default TreeSelect;