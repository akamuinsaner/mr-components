var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,a=1,r=arguments.length;a<r;a++)for(var o in t=arguments[a])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},__rest=this&&this.__rest||function(e,t){var a={};for(o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(a[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var r=0,o=Object.getOwnPropertySymbols(e);r<o.length;r++)t.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(a[o[r]]=e[o[r]]);return a},__read=this&&this.__read||function(e,t){var a="function"==typeof Symbol&&e[Symbol.iterator];if(!a)return e;var r,o,n=a.call(e),i=[];try{for(;(void 0===t||0<t--)&&!(r=n.next()).done;)i.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(a=n.return)&&a.call(n)}finally{if(o)throw o.error}}return i},__spreadArray=this&&this.__spreadArray||function(e,t,a){if(a||2===arguments.length)for(var r,o=0,n=t.length;o<n;o++)!r&&o in t||((r=r||Array.prototype.slice.call(t,0,o))[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))};import{jsx as _jsx,Fragment as _Fragment,jsxs as _jsxs}from"react/jsx-runtime";import React from"react";import TextField from"@mui/material/TextField";import ArrowDropDownIcon from"@mui/icons-material/ArrowDropDown";import Autocomplete from"@mui/material/Autocomplete";import CancelIcon from"@mui/icons-material/Cancel";import Chip from"@mui/material/Chip";import Tag from"./Tag";import DropDown from"./DropDown";import Options from"./Options";import useTagLimits from"./useTagLimits";import getTreeDataFormatted from"../utils/getTreeDataFormatted";import useExpanded from"./useExpanded";import useLoadData from"./useLoadData";import useSearch from"./useSearch";import useAnchor from"./useAnchor";var TreeSelect=function(e){function t(){return w([])}function a(){var e;return i?j:!!b&&o?A:(null==(e=T.get(j[0]))?void 0:e.name)||""}var r=e.search,o=void 0!==r&&r,n=e.options,r=e.multiple,i=void 0!==r&&r,r=e.placement,r=void 0===r?"bottom-start":r,l=e.checkable,l=void 0!==l&&l,s=e.checkWithRelation,p=e.defaultExpandAll,p=void 0!==p&&p,u=e.defaultExpandedKeys,c=e.popperStyle,c=void 0===c?{}:c,d=e.popperClassName,m=e.value,f=e.expandedKeys,h=e.onChange,g=e.onExpand,_=e.loadData,x=e.allowClear,x=void 0!==x&&x,y=e.maxTagCount,v=void 0===y?0:y,D=__rest(e,["search","options","multiple","placement","checkable","checkWithRelation","defaultExpandAll","defaultExpandedKeys","popperStyle","popperClassName","value","expandedKeys","onChange","onExpand","loadData","allowClear","maxTagCount"]),C=React.useRef(!1),y=__read(React.useState(getTreeDataFormatted(n)),2),e=y[0],E=y[1],y=e.flattedData,T=e.idTreeNodeMap,m=(React.useEffect(function(){C.current?E(getTreeDataFormatted(n)):C.current=!0},[n]),__read(React.useState(Array.isArray(m)?m:m?[m]:[]),2)),j=m[0],w=m[1],m=__read(React.useState(!1),2),K=m[0],W=m[1],m=(React.useEffect(function(){K?h&&h(i?j:j[0]):W(!0)},[j]),useSearch({search:o,multiple:i,dataSet:e})),P=m.searchData,A=m.inputValue,m=m.onInputChange,y=useExpanded({flattedData:y,defaultExpandAll:p,defaultExpandedKeys:u,expandedKeys:f,onExpand:g}),p=y.expandKeys,u=y.toggleExpand,f=useLoadData({loadData:_,toggleExpand:u}),g=f.loadingId,y=f.startLoadData,f=useAnchor({onInputChange:m}),b=f.anchorEl,S=f.inputRef,O=f.eleRef,R=f.openDropDown,z=f.hovering,I=f.setHovering,f=useTagLimits({maxTagCount:v,selected:j,inputRef:S}),F=f.tagLimit,k=f.tagWidths,L=f.setTagWidths;return _jsxs(_Fragment,{children:[_jsx(Autocomplete,{ref:O,options:[],open:!1,disabled:D.disabled,onFocus:R,readOnly:!(o&&b),multiple:i,disableClearable:!0,value:a(),inputValue:A,onClick:function(e){return e.stopPropagation()},onInputChange:m,onMouseEnter:function(e){return I(!0)},onMouseLeave:function(e){return I(!1)},popupIcon:z&&j.length&&x?_jsx(CancelIcon,{onClick:t}):_jsx(ArrowDropDownIcon,{onClick:R}),renderInput:function(e){var t=!!b;return _jsx(TextField,__assign({},e,D,{onClick:function(e){return e.stopPropagation()},focused:t,ref:S,placeholder:t&&!i?a():D.placeholder,sx:{"& .MuiAutocomplete-inputRoot":{flexWrap:"responsive"===v?"nowrap":"wrap"}}}))},renderTags:function(e,t){var a=e.slice(0,F),e=e.slice(F),r=D.size;return a.map(function(e,a){e=T.get(e);return _jsx(Tag,{size:r,onDelete:function(t){w(j.filter(function(e){return e!==t})),L(k.filter(function(e,t){return t!==a}))},option:e,onInit:function(e){var t=__spreadArray([],__read(k),!1);t[a]=e,L(t)}})}).concat(e.length?[_jsx(Chip,{size:r,label:"+".concat(e.length,"...")})]:[])}}),_jsx(DropDown,__assign({anchorEl:b,placement:r,popperStyle:c,popperClassName:d,initialWidth:null==(f=null==O?void 0:O.current)?void 0:f.offsetWidth},{children:_jsx(Options,{dense:"small"===D.size,showCheck:i&&l,multiple:i,selected:j,setSelected:w,loadData:_,expandKeys:p,toggleExpand:u,dataSet:e,checkWithRelation:s,loadingId:g,startLoadData:y,searchData:P})}))]})};export default TreeSelect;