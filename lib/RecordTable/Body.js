var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var n,o=1,r=arguments.length;o<r;o++)for(var t in n=arguments[o])Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t]);return e}).apply(this,arguments)},__read=this&&this.__read||function(e,n){var o="function"==typeof Symbol&&e[Symbol.iterator];if(!o)return e;var r,t,a=o.call(e),l=[];try{for(;(void 0===n||0<n--)&&!(r=a.next()).done;)l.push(r.value)}catch(e){t={error:e}}finally{try{r&&!r.done&&(o=a.return)&&o.call(a)}finally{if(t)throw t.error}}return l},__spreadArray=this&&this.__spreadArray||function(e,n,o){if(o||2===arguments.length)for(var r,t=0,a=n.length;t<a;t++)!r&&t in n||((r=r||Array.prototype.slice.call(n,0,t))[t]=n[t]);return e.concat(r||Array.prototype.slice.call(n))};import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from"react/jsx-runtime";import React from"react";import{TableBody,TableRow,TableCell,Checkbox,Radio,IconButton}from"@mui/material";import{MRTableContext}from".";import{getCellData,getRowKey,getRowClassName,getFixedStyle}from"./helper";import KeyboardArrowDownIcon from"@mui/icons-material/KeyboardArrowDown";import KeyboardArrowUpIcon from"@mui/icons-material/KeyboardArrowUp";import{DndContext,closestCenter,KeyboardSensor,PointerSensor,useSensor,useSensors}from"@dnd-kit/core";import{SortableContext,sortableKeyboardCoordinates,verticalListSortingStrategy}from"@dnd-kit/sortable";import{restrictToVerticalAxis}from"@dnd-kit/modifiers";import{useSortable}from"@dnd-kit/sortable";import{CSS}from"@dnd-kit/utilities";import styles from"../index.module.css";import classNames from"classnames";var RecordTableBodyCell=function(e){var n=e.data,o=e.align,r=e.onCell,t=e.width,a=e.columns,l=e.column,s=e.columnKey,i=e.fixed,d=e.scrollingInfo,e=e.columnIndex,c=null==r?void 0:r.colSpan,u=null==r?void 0:r.rowSpan,x=React.useContext(MRTableContext),m=x.expandable,f=x.rowSelection,x=x.scroll;if(0!==c&&0!==u)return r=(null==r?void 0:r.sx)||{},x=null!=x&&x.x?getFixedStyle(i,a,s,null==m?void 0:m.fixed,null==f?void 0:f.fixed):{},r=Object.assign({},x,r),i=!d.scrollLeft&&"left"===l.fixed&&a[e+1]&&"left"!==a[e+1].fixed,s=!d.scrollRight&&"right"===l.fixed&&a[e-1]&&"right"!==a[e-1].fixed,_jsx(TableCell,__assign({align:o,colSpan:c,rowSpan:u,width:t,sx:r,className:classNames(((m={})[styles["mr-table-column-scroll-left"]]=i,m[styles["mr-table-column-scroll-right"]]=s,m))},{children:n}))},RecordTableRow=function(e){function o(e){e.target.checked?C(Array.from(new Set(__spreadArray(__spreadArray([],__read(w),!1),[h],!1))),_,!0,y):C(w.filter(function(e){return e!==h}),_,!1,y)}function r(e){e.target.checked?C([h],_,!0,y):C([],_,!1,y)}function n(){return b.map(function(e,n){return _jsx(RecordTableBodyCell,{columnKey:e.key,width:e.width,align:e.align,data:getCellData(e,y,_),onCell:e.onCell&&e.onCell(y,_),columns:b,column:e,columnIndex:n,fixed:e.fixed,scrollingInfo:v},e.key)})}function t(){var e,n;return K?(e={},n=classNames(((n={})[styles["mr-table-selection-fixed"]]=null==K?void 0:K.fixed,n[styles["mr-table-selection-fixed-after-expand"]]=null==j?void 0:j.fixed,n)),"radio"===K.type?_jsx(TableCell,__assign({sx:e,padding:"checkbox",className:n},{children:_jsx(Radio,{checked:w[0]===h,onChange:r})})):_jsx(TableCell,__assign({className:n,sx:e,padding:"checkbox"},{children:_jsx(Checkbox,{checked:w.includes(h),onChange:o})}))):null}function a(){var e;return j?(e=classNames(((e={})[styles["mr-table-expandable-fixed"]]=null==j?void 0:j.fixed,e)),_jsx(TableCell,__assign({padding:"checkbox",sx:{},className:e},{children:_jsx(IconButton,__assign({size:"small",onClick:function(e){e.stopPropagation(),S(h,!R,y)}},{children:null!=j&&j.expandIcon?null==j?void 0:j.expandIcon(y,_,R):k}))}))):null}function l(){var e,n,o;return R&&j?(e=b.length+1,K&&(e+=1),n=null!=j&&j.expandedRowClassName?j.expandedRowClassName(y,_):"",o=null!=j&&j.expandedRowRender?j.expandedRowRender(y,_,R):"",_jsx(TableRow,__assign({className:n},{children:_jsx(TableCell,__assign({colSpan:e},{children:o}))}))):null}function s(e){e.stopPropagation(),null!=j&&j.expandRowByClick&&S(h,!R,y)}var i,d,c,u,x,m,f,g,p,y=e.record,b=e.columns,_=e.rowIndex,h=e.rowKey,w=e.selectRowKeys,C=e.onSelectChange,R=e.expanded,S=e.onExpandChange,v=e.scrollingInfo,e=React.useContext(MRTableContext),j=e.expandable,K=e.rowSelection,T=e.rowClassName,e=e.dropable,k=_jsx(R?KeyboardArrowUpIcon:KeyboardArrowDownIcon,{});return e?(i=!!e.disabledRows&&e.disabledRows(y,_),d=(g=useSortable({id:h,disabled:i})).attributes,c=g.listeners,u=g.setNodeRef,p=g.transform,x=g.transition,m=g.isDragging,f=g.isSorting,g=g.isOver,console.log(m,g,f),g=Object.assign({},{transform:CSS.Transform.toString(p),transition:x},m?null==e?void 0:e.dragStyle:null),p=classNames(getRowClassName(y,T,_),((f={})[styles["mr-table-row-disable"]]=i,f[styles["mr-table-row-dragging"]]=m,f)),_jsxs(_Fragment,{children:[_jsxs(TableRow,__assign({hover:!0,tabIndex:-1,className:p,onClick:s,ref:u,sx:g},c,d,{children:[a(),t(),n()]}),h),l()]})):_jsxs(_Fragment,{children:[_jsxs(TableRow,__assign({hover:!0,tabIndex:-1,className:getRowClassName(y,T,_),onClick:s},{children:[a(),t(),n()]}),h),l()]})},RecordTableBody=function(e){function n(){return s.map(function(e,n){var o=getRowKey(e,l,n),r=d.includes(o);return _jsx(RecordTableRow,{columns:t,record:e,rowIndex:n,rowKey:o,selectRowKeys:a,onSelectChange:i,expanded:r,onExpandChange:c,scrollingInfo:x},o)})}var o,l=e.rowKey,t=e.columns,s=e.dataSource,a=e.selectRowKeys,i=e.onSelectChange,d=e.expandedRowKeys,c=e.onExpandChange,u=e.pageParams,x=e.scrollingInfo,m=React.useContext(MRTableContext).dropable;return m?(e=useSensors(useSensor(PointerSensor,{activationConstraint:{delay:m.delay||0,distance:m.distance||0}}),useSensor(KeyboardSensor,{coordinateGetter:sortableKeyboardCoordinates})),o=[],null!=m&&m.lockAxis&&o.push(restrictToVerticalAxis),_jsx(TableBody,{children:_jsx(DndContext,__assign({sensors:e,collisionDetection:closestCenter,onDragEnd:function(e){var n=e.active,e=e.over,o=n.id,r=e.id,n=s.find(function(e,n){return getRowKey(e,l,n)===o}),e=s.find(function(e,n){return getRowKey(e,l,n)===r}),t=s.findIndex(function(e,n){return getRowKey(e,l,n)===o}),a=s.findIndex(function(e,n){return getRowKey(e,l,n)===r});null!=m&&m.onDropEnd({key:o,index:t+u.page*u.rowsPerPage,record:n},{key:r,index:a+u.page*u.rowsPerPage,record:e})},modifiers:o},{children:_jsx(SortableContext,__assign({items:s.map(function(e,n){return getRowKey(e,l,n)}),strategy:verticalListSortingStrategy},{children:n()}))}))})):_jsx(TableBody,{children:n()})};export default RecordTableBody;