var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var n,o=1,r=arguments.length;o<r;o++)for(var t in n=arguments[o])Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t]);return e}).apply(this,arguments)},__read=this&&this.__read||function(e,n){var o="function"==typeof Symbol&&e[Symbol.iterator];if(!o)return e;var r,t,a=o.call(e),i=[];try{for(;(void 0===n||0<n--)&&!(r=a.next()).done;)i.push(r.value)}catch(e){t={error:e}}finally{try{r&&!r.done&&(o=a.return)&&o.call(a)}finally{if(t)throw t.error}}return i},__spreadArray=this&&this.__spreadArray||function(e,n,o){if(o||2===arguments.length)for(var r,t=0,a=n.length;t<a;t++)!r&&t in n||((r=r||Array.prototype.slice.call(n,0,t))[t]=n[t]);return e.concat(r||Array.prototype.slice.call(n))};import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from"react/jsx-runtime";import React from"react";import{TableBody,TableRow,TableCell,Checkbox,Radio,IconButton}from"@mui/material";import{MRTableContext}from".";import{getCellData,getRowKey,getRowClassName,getFixedStyle}from"./helper";import KeyboardArrowDownIcon from"@mui/icons-material/KeyboardArrowDown";import KeyboardArrowUpIcon from"@mui/icons-material/KeyboardArrowUp";import{DndContext,closestCenter,KeyboardSensor,PointerSensor,useSensor,useSensors}from"@dnd-kit/core";import{SortableContext,sortableKeyboardCoordinates,verticalListSortingStrategy}from"@dnd-kit/sortable";import{restrictToVerticalAxis}from"@dnd-kit/modifiers";import{useSortable}from"@dnd-kit/sortable";import{CSS}from"@dnd-kit/utilities";var RecordTableBodyCell=function(e){var n=e.data,o=e.align,r=e.onCell,t=e.width,a=e.columns,i=e.columnKey,e=e.fixed,l=null==r?void 0:r.colSpan,s=null==r?void 0:r.rowSpan;if(0!==l&&0!==s)return r=(null==r?void 0:r.sx)||{},e=getFixedStyle(e,a,i),r=Object.assign({},e,r),_jsx(TableCell,__assign({align:o,colSpan:l,rowSpan:s,width:t,sx:r},{children:n}))},RecordTableRow=function(e){function n(e){e.target.checked?h(Array.from(new Set(__spreadArray(__spreadArray([],__read(m),!1),[_],!1))),y,!0,f):h(m.filter(function(e){return e!==_}),y,!1,f)}function o(e){e.target.checked?h([_],y,!0,f):h([],y,!1,f)}function r(){return b.map(function(e){return _jsx(RecordTableBodyCell,{columnKey:e.key,width:e.width,align:e.align,data:getCellData(e,f,y),onCell:e.onCell&&e.onCell(f,y),columns:b,fixed:e.fixed},e.key)})}function t(){return S?"radio"===S.type?_jsx(TableCell,__assign({padding:"checkbox"},{children:_jsx(Radio,{checked:m[0]===_,onChange:o})})):_jsx(TableCell,__assign({padding:"checkbox"},{children:_jsx(Checkbox,{checked:m.includes(_),onChange:n})})):null}function a(){return R?_jsx(TableCell,__assign({padding:"checkbox"},{children:_jsx(IconButton,__assign({size:"small",onClick:function(e){e.stopPropagation(),C(_,!w,f)}},{children:null!=R&&R.expandIcon?null==R?void 0:R.expandIcon(f,y,w):v}))})):null}function i(){var e,n,o;return w&&R?(e=b.length+1,S&&(e+=1),n=null==R?void 0:R.expandedRowClassName(f,y),o=null==R?void 0:R.expandedRowRender(f,y,w),_jsx(TableRow,__assign({className:n},{children:_jsx(TableCell,__assign({colSpan:e},{children:o}))}))):null}function l(e){e.stopPropagation(),null!=R&&R.expandRowByClick&&C(_,!w,f)}var s,d,c,u,g,x,p,f=e.record,b=e.columns,y=e.index,_=e.rowKey,m=e.selectRowKeys,h=e.onSelectChange,w=e.expanded,C=e.onExpandChange,e=React.useContext(MRTableContext),R=e.expandable,S=e.rowSelection,j=e.rowClassName,e=e.dropable,v=_jsx(w?KeyboardArrowUpIcon:KeyboardArrowDownIcon,{});return e?(s=!!e.disabledRows&&e.disabledRows(f,y),d=(x=useSortable({id:_,disabled:s})).attributes,c=x.listeners,u=x.setNodeRef,p=x.transform,g=x.transition,x=x.isDragging,p={transform:CSS.Transform.toString(p),transition:g,cursor:"grab"},x&&(p=Object.assign({},p,{background:"#fff",boxShadow:"8px 5px 10px rgba(0, 0, 0, 0.3)",userSelect:"none"},e.dragStyle)),s&&(p=Object.assign({},p,{cursor:"not-allowed",background:"#eee","& .MuiTableCell-root":{color:"#aaa"}},e.disableStyle)),_jsxs(_Fragment,{children:[_jsxs(TableRow,__assign({hover:!0,tabIndex:-1,className:getRowClassName(f,j,y),onClick:l,ref:u,sx:p},c,d,{children:[a(),t(),r()]}),_),i()]})):_jsxs(_Fragment,{children:[_jsxs(TableRow,__assign({hover:!0,tabIndex:-1,className:getRowClassName(f,j,y),onClick:l},{children:[a(),t(),r()]}),_),i()]})},RecordTableBody=function(e){function n(){return l.map(function(e,n){var o=getRowKey(e,i,n),r=d.includes(o);return _jsx(RecordTableRow,{columns:t,record:e,index:n,rowKey:o,selectRowKeys:a,onSelectChange:s,expanded:r,onExpandChange:c},o)})}var o,i=e.rowKey,t=e.columns,l=e.dataSource,a=e.selectRowKeys,s=e.onSelectChange,d=e.expandedRowKeys,c=e.onExpandChange,u=e.pageParams,g=React.useContext(MRTableContext).dropable;return g?(e=useSensors(useSensor(PointerSensor,{activationConstraint:{delay:g.delay||0,distance:g.distance||0}}),useSensor(KeyboardSensor,{coordinateGetter:sortableKeyboardCoordinates})),o=[],null!=g&&g.lockAxis&&o.push(restrictToVerticalAxis),_jsx(TableBody,{children:_jsx(DndContext,__assign({sensors:e,collisionDetection:closestCenter,onDragEnd:function(e){var n=e.active,e=e.over,o=n.id,r=e.id,n=l.find(function(e,n){return getRowKey(e,i,n)===o}),e=l.find(function(e,n){return getRowKey(e,i,n)===r}),t=l.findIndex(function(e,n){return getRowKey(e,i,n)===o}),a=l.findIndex(function(e,n){return getRowKey(e,i,n)===r});null!=g&&g.onDropEnd({key:o,index:t+u.page*u.rowsPerPage,record:n},{key:r,index:a+u.page*u.rowsPerPage,record:e})},modifiers:o},{children:_jsx(SortableContext,__assign({items:l.map(function(e,n){return getRowKey(e,i,n)}),strategy:verticalListSortingStrategy},{children:n()}))}))})):_jsx(TableBody,{children:n()})};export default RecordTableBody;